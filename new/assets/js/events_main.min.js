import{fieldMaker as e,formReader as t}from"./modules/fields.js";import*as n from"./modules/cache.js";import*as i from"./modules/modal.js";import*as s from"./modules/search.js";import*as r from"./modules/svg.js";import*as o from"./modules/utils.js";class Consent{constructor(e,t,n){this._id=+e,this._label=t,this._text=n}get id(){return this._id}get label(){return this._label}get text(){return this._text}static fromJson(e){let t=e;return"string"==typeof e&&(t=JSON.parse(e)),new Consent(t.id,t.label,t.text)}}class Consents{constructor(e=[],t=[],n=[]){this._adults=e,this._children=t,this._foreign=n}get adults(){return this._adults}get children(){return this._children}get foreign(){return this._foreign}get hasAll(){return this.adults.length>0&&this.children.length>0&&this.foreign.length>0}get areAllEmpty(){return!this.adults.length&&!this.children.length&&!this.foreign.length}get isOnlyAdults(){return this.adults.length>0&&!this.children.length&&!this.foreign.length}get isOnlyForeign(){return!this.adults.length&&!this.children.length&&this.foreign.length>0}get hasAdultsAndChildren(){return this.adults.length>0&&this.children.length>0}get hasAdultsAndForeign(){return this.adults.length>0&&this.foreign.length>0}add(e,t){this[e].push(Consent.fromJson(t))}findConsent(e,t=""){let n=t=>t.find(t=>+t.id==+e);return isNaN(e)||!e||e<0?void 0:t?n(this[t]):n(this.adults)||n(this.children)||n(this.foreign)}}class Form{constructor(e,t,n,i=0){this._element_id=+e,this._form=t,this._consents=n,this._minAge=i}get element_id(){return this._element_id}get form(){return this._form}get consents(){return this._consents}get minAge(){return this._minAge}get hasAge(){return this.hasField("age")}get hasForeign(){return this.hasField("is_foreign[]")}hasField(e){return this._form.some(t=>t.name===e)}static fromJson(e){let t=e;return"string"==typeof e&&(t=JSON.parse(e)),new Form(t.element_id,t.form,t.consents,t.minAge??0)}}class Checker{constructor(e,t){this._fd=e,this._form=t}get fd(){return this._fd}get form(){return this._form}static get age(){let e=o.form.window.find('input[name="age"]');return!e.length||isNaN(e.val())?null:+e.val()}static get isForeign(){let e=o.form.window.find('input[name="is_foreign[]"');return e.length?e.is(":checked"):null}check(){return this.checkForm()?this.checkConsents()?this.fd:(showNotification(!1,o.makeNotificationText('Невозможно записаться без согласий на обработку <span title="Персональные Данные">ПД</span>'),4e3),null):null}checkForm(){if(!1===Checker.checkAgeInput(0,this.form.minAge)||!1===Checker.checkEmailInput())return null;for(let[e,n]of Object.entries(this.form.form)){let i=t[n.type](n,this.fd);if(!i&&null!==i)return null}return!0}checkConsents(){let e=this.form.consents,t=e=>({all:$(`.consents .${e} input`),checked:$(`.consents .${e} input:checked`)}),n=e=>t(e).all.length===t(e).checked.length,i=e=>{let n=this.fd;t(e).all.each(function(){n.append($(this).attr("name"),$(this).val())}),this._fd=n},s=e=>(i(e),n(e));return this.form.hasAge&&!Checker.checkAgeInput()?null:!!e.areAllEmpty||(e.isOnlyAdults?s("adults"):e.isOnlyForeign?s("foreign"):e.hasAll?s(Checker.isForeign?"foreign":Checker.age>17?"adults":"children"):e.hasAdultsAndChildren?s(Checker.age>17?"adults":"children"):e.hasAdultsAndForeign?s(Checker.isForeign?"foreign":"adults"):void 0)}static checkAge(e,t=0){if(e>4&&e<131&&!isNaN(e)&&t<e)return!0;let n="Установлен недопустимый возраст";return e<t&&(n=`Мероприятие доступно лишь с ${t} лет`),showNotification(!1,o.makeNotificationText(n),2e3),o.highlightField({name:"age"}),!1}static checkAgeInput(e=0,t=0){e&&Checker.checkAge(e,t);let n=o.form.window.find('input[name="age"]');return n.length?Checker.checkAge(n.val(),t):null}static checkEmail(e){return!!String(e).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)||(showNotification(!1,o.makeNotificationText("Введен некорректный email"),2e3),o.highlightField({name:"email"}),!1)}static checkEmailInput(e=""){e&&Checker.checkEmail(e);let t=o.form.window.find('input[name="email"]');return t.length?Checker.checkEmail(t.val()):null}}class ConsentShower{constructor(e){this._form=e}get form(){return this._form}work(){var e,t;let n=()=>{if(i.every.hide(),Checker.isForeign){i.foreign.show();return}if(o.form.window.find('input[name="age"]').length>0&&!Checker.checkAgeInput())return;let e=Checker.age;e>17||null===e?i.adults.show():i.children.show()},i={all:$(".consents"),every:$(".consents .adults, .consents .children, .consents .foreign"),adults:$(".consents .adults"),children:$(".consents .children"),foreign:$(".consents .foreign")},s=this.form.consents;!s.areAllEmpty&&!s.isOnlyForeign&&!s.isOnlyAdults&&((s.children.length||(e=s.adults.length>0,t=s.foreign.length>0,(!e||t)&&(e||!t)))&&s.hasAdultsAndChildren&&this.form.hasAge&&!s.foreign.length?i.every.hide():i.every.show(),this.form.hasAge&&(n(),o.form.window.find('input[name="age"]').on("change",n)),this.form.hasForeign&&(n(),o.form.window.find('input[name="is_foreign[]"]').on("change",n)))}}let formReceived=function(e,t,i){let s=new Consents;for(let[r,o]of Object.entries(e.consents))for(let a of o)s.add(r,a);let l=new Form(t,e.form,s,e.min_age??0);n.addToCache(l),showForm(l),$(i).find("div i").remove()},getForm=function(){if($(this).hasClass("button-record-event-disabled"))return;let e=$(this).attr("id"),t=n.findCachedForm(e),i=$(this);if(t){showForm(t);return}o.addSpinner(i);let s=new FormData;s.append("id",e),$.ajax({type:"POST",url:"/events_registration/new/ajax/get_event_form.php",data:s,processData:!1,contentType:!1,success:t=>formReceived(t,e,i),error(t){o.removeSpinner(i),t.status&&makeDisabled(e),showNotification(!1,(t=JSON.parse(t.responseText)).message??o.makeNotificationText('Обратитесь с этой ошибкой к <a href="https://new.vyatsu.ru/account/notifications/?ELEMENT_ID=789249"> администратору </a>'),4e3)}})},getAuthForm=function(){if($(this).hasClass("button-record-event-disabled"))return;let e=n.findCachedForm(0),t=$(this);if(e){showForm(e);return}o.addSpinner(t),$.ajax({type:"GET",url:"/events_registration/new/ajax/get_auth_form.php",processData:!1,contentType:!1,success:e=>formReceived(e,0,t),error(e){o.removeSpinner(t),e.status&&makeDisabled(0),showNotification(!1,(e=JSON.parse(e.responseText)).message??o.makeNotificationText('Обратитесь с этой ошибкой к <a href="https://new.vyatsu.ru/account/notifications/?ELEMENT_ID=789249"> администратору </a>'),4e3)}})},showForm=function(t){for(let[n,i]of($("body").css("overflow","hidden"),o.form.container.fadeIn(100),o.form.window.html(""),Object.entries(t.form)))if(i.type&&void 0!==e[i.type]){if("header"===i.type||"text"===i.type){o.form.window.append('<div class="omrs-input-group clear_span">'+e[i.type](i)+"</div>");continue}o.form.window.append('<div class="omrs-input-group">'+e[i.type](i)+"</div>")}if(o.renderConsents(t.consents,t.hasAge,t.hasForeign),o.form.window.append(`<div class="button-record-event button-register clear_span" id="${t.element_id}"><div>Записаться</div><div class="button-flare"></div></div>`),t.hasForeign||t.hasAge){let s=new ConsentShower(t);s.work()}$('input[name="phone"]').inputmask("+9(9{3})9{3}-9{4}")},hideForm=()=>{o.form.container.fadeOut({duration:400}),$("body").css("overflow","auto")},generateFormData=function(e,t){let i=n.findCachedForm(e);if(!i&&t)return showNotification(!1,o.makeNotificationText('Невозможно отправить форму<br>Обратитесь с этой ошибкой к <a href="https://new.vyatsu.ru/account/notifications/?ELEMENT_ID=789249"> администратору </a>'),4e3),null;if(t&&!$("#consents_pd").is(":checked")&&"0"!==e)return showNotification(!1,o.makeNotificationText("Не поставлена галка о согласии с обработкой ПД"),4e3),null;let s=new FormData;if(s.append("id",`${e}`),!t)return s;let r=new Checker(s,i);return r.check()},uploadedSuccessfully=function(e,t,n){o.removeSpinner(n),showNotification(!0,o.makeNotificationText(e.message),2e3),hideForm(),makeDisabled(t),e.refresh&&location.reload()},upload=function(){let e=$(this).attr("id"),t=$(this),n=generateFormData(e,!$(this).hasClass("not-fill"));null!==n&&(o.addSpinner(t),$.ajax({type:"POST",url:"/events_registration/new/ajax/event_register.php",data:n,processData:!1,contentType:!1,success:n=>uploadedSuccessfully(n,e,t),error(e){o.removeSpinner(t);try{e=JSON.parse(e.responseText)}catch(n){showNotification(!1,'<div class="logo"></div> <div class="notif_text">Обратитесь с этой ошибкой к <a href="https://new.vyatsu.ru/account/notifications/?ELEMENT_ID=789249"> администратору </a></div>',4e3);return}showNotification(!1,e.message??'<div class="logo"></div> <div class="notif_text">Обратитесь с этой ошибкой к <a href="https://new.vyatsu.ru/account/notifications/?ELEMENT_ID=789249"> администратору </a></div>',4e3),o.highlightField(e.payload)}}))},makeDisabled=function(e){$("#"+e+".get_form").eq(0).addClass("button-record-event-disabled"),$("#"+e+".not-fill").eq(0).addClass("button-record-event-disabled")},showConsentPopup=function(){var e;let t=function(e,t){return`<div class="${e}"><div>`+t+'</div><div class="button-flare"></div></div>'},i=$(this).find("input");if("pd"===i.prop("name"))return;let s=i.val();i.prop("checked",!1);let r=$(".button-register").attr("id"),o=$(this).parent().prop("className"),a=n.findConsent(r,s,o),l={window:$(".consent-window"),container:$(".consent-container")};l.window.html(""),l.window.append(`<h2 class="title-form">${a.label}</h2><div class="consent-text"><p>${a.text}</p></div>`),l.window.append('<div class="button-group">'+t("button-record-event","Принимаю")+t("button-record-event-negative","Не принимаю")+"</div>"),$(".button-record-event").on("click",(e=i,()=>{e.prop("checked",!0),hideConsentPopup()})),$("body").css("overflow","hidden"),l.container.fadeIn(100)},hideConsentPopup=function(){let e={window:$(".consent-window"),container:$(".consent-container")};e.window.html(""),o.form.container.is(":hidden")&&$("body").css("overflow","auto"),e.container.fadeOut(100)};$(".button-description-event").on("mousedown",o.jumpToEventPage),$(".get-table").on("mousedown",o.jumpToEventPage),$(".make-excel").on("mousedown",o.jumpToEventPage),$(".get_form").on("click",getForm),$(".get_auth_form").on("click",getAuthForm),$(document).on("click",".consent-checkbox",showConsentPopup),$(document).on("click",".consent-window .button-record-event-negative",hideConsentPopup),$(document).on("click",".button-register",upload),$(".check-photo-event-wrapper").on("click",o.rotateCheckMark),$(document).mousedown(function(e){let t=o.form.container;0===t.has(e.target).length&&$(".form-window").is(":visible")&&1===e.which&&hideForm()}),$(document).on("focus","input[name*='date']",function(){$(this).mask("99.99.9999",{reverse:!0})});
